<!DOCTYPE HTML>
<html>
  <head>
    <title>CaffeJS Sample - Age Prediction</title>

    <script src="libs/d3.min.js"></script>
    <script src="libs/webcam.min.js"></script>
    <script src="libs/long.min.js"></script>
    <script src="libs/bytebuffer.min.js"></script>
    <script src="libs/protobuf.min.js"></script>
    <script src="libs/caffe.js"></script>

    <style>
      .net-layer {
        position: relative;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .net-vis {
        margin-left: 200px;
      }

      .net-description {
        width: 200px;
        position: absolute;
        margin-right: 20px;
      }
    </style>
  </head>
  <body>
   
    <div class='camera' style="width:227px; height:227px;"></div>
    <div>
      <button onclick="snap()" class="take-picture" style="display: none;">Picture</button>
      <button onclick="visualize()" class="take-picture" style="display: none;">Visualize Activations</button>
    </div>

    <div class="model"></div>

    <script language="JavaScript">
      var nj = NumJS;
      var jil = ImgJS;
      var image = new jil.Image();

      // Image dimensions
      var width = 256;
      var height = 256;

      // Compare top-n labels
      var n = 5;
      var format = d3.format('.2%');

      // Let's hook up the webcam
      Webcam.attach('.camera');
      Webcam.set({
        width: width,
        height: height
      });

      // Let's create a GoogLeNet model from Caffe
      var model = new Net.CaffeModel(
        'models/age_net/deploy.prototxt',
        'models/age_net/weights/'
      );

      var mean;
      var p = new Parser.BlobProtoParser();
      p.parse('models/age_net/mean.binaryproto').then(function(data){
        mean = data.zoom(width/data.sx, height/data.sy);

        // Debug the mean
        var img = ImgJS.Image.fromMean(mean);
        img.render();
      });
      
      model.load().then(function(){
        console.log('Finished loading.');
        d3.selectAll('.take-picture')
          .style('display', 'block');
      });

      function snap() {
        Webcam.snap(function(data_uri, canvas, ctx) {
          var data = ctx.getImageData(0, 0, width, height);
          var input = image.set(data, width, height).toVol(mean, [2,1,0]);

          console.log(input);

          var scores = model.forward(input);
          var topInd = nj.argmaxn(scores.w, n);
          var topVal = nj.maxn(scores.w, n);

          console.log(scores);
          console.log(topInd);
          console.log(topVal);

        });
      }

      function visualize() {
        Utils.FilterDrawer.fromNet(model).render('.model');
      }
    </script>

  </body>
</html>