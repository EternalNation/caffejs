<!DOCTYPE HTML>
<html>
  <head>
    <title>CaffeJS Sample - Using the Webcam</title>

    <script src="libs/d3.min.js"></script>
    <script src="libs/caffe.js"></script>

    <style>
      .net-layer {
        position: relative;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .net-vis {
        margin-left: 200px;
      }

      .net-description {
        width: 200px;
        position: absolute;
        margin-right: 20px;
      }
    </style>
  </head>
  <body>
   
    <canvas id="image"></canvas>
    <br>
    <div>
      <button onclick="forward()" class="net-ready" style="display: none;">Run Forward Pass</button>
      <button onclick="visualize()" class="net-ready" style="display: none;">Visualize Activations</button>
      <select name="modelSelect">
        <option value="alexnet">AlexNet</option>
        <option selected="selected" value="googlenet">GoogLeNet</option>
      </select>
    </div>

    <div class="model"></div>

    <script language="JavaScript">
      var imgUrl = "picture_square.jpg";
      var canvas = document.getElementById('image');
      var nj = NumJS;
      var jil = ImgJS;
      var image;

      // Image dimensions
      var width = 224;
      var height = 224;
      
      // Compare top-n labels
      var n = 5;
      var format = d3.format('.2%');

      var labels;
      d3.text('data/ilsvrc12/synset_words.txt', function(data){
        labels = data.split('\n').map(function(d){
          return d.substr(10);
        });
      });

      // Let's create a GoogLeNet model from Caffe
      var model = new Net.CaffeModel(
        'models/bvlc_googlenet/deploy.prototxt',
        'models/bvlc_googlenet/weights/'
      );

      // the mean value can be found in train_val.prototxt
      var mean = [104.0, 116.0, 122.0];
      
      model.load().then(function(){
        console.log('Finished loading.');
        d3.selectAll('.net-ready')
          .style('display', 'block');
        forward();
      });

      d3.select('select[name="modelSelect"]').on('change', function(){
        
        d3.selectAll('.net-ready')
          .style('display', 'none');

        var m = d3.select('select[name="modelSelect"]').property("value");
        if (m == 'alexnet') {
          model = new Net.CaffeModel(
            'models/bvlc_alexnet/deploy.prototxt',
            'models/bvlc_alexnet/weights/'
          );
        }
        else {
          model = new Net.CaffeModel(
            'models/bvlc_googlenet/deploy.prototxt',
            'models/bvlc_googlenet/weights/'
          );
        }

        model.load().then(function(){
          d3.selectAll('.net-ready')
            .style('display', 'block');
          });
      });

      function objective_L2(dst) {
        dst.out_act.dw.set(dst.out_act.w);
      }

      function forward() {
        image = new jil.Image(imgUrl);
        return image.load().then(function(){
          image.render(canvas);
          
          var end = "prob";
          console.log(image.toVol(undefined, [0,1,2]));

          var input = image.toVol(mean, [2,1,0]);
          model.setInputDimensions(input.sx, input.sy);
          console.log(input);

          var src = model.getLayer('data');
          var dst = model.getLayer(end);

          var scores = model.forward(input, false, {end: end});
          console.log(scores);

          // objective_L2(dst)  // specify the optimization objective
          // model.backward(undefined, {start: end})

          // var out_data = src.out_act;
          // var diff = out_data.dw;

          // console.log(diff);
        });
      }

      function visualize() {
        Utils.FilterDrawer.fromNet(model).render('.model');
      }
    </script>

  </body>
</html>