var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},NumJS;!function(t){function e(e,i){return void 0===i&&(i=t.DEFAULT_TYPE_INSTANCE),new i(e)}function i(t,e){for(var i=0,r=t.length;i<r;++i)t[i]=e;return t}function r(t){for(var e=1,i=0,r=t.length;i<r;++i)e*=t[i];return e}function s(t){for(var e=0,i=0,r=t.length;i<r;++i)e+=t[i];return e}function o(t,e){if(t.length===e.length){for(var i=0,r=t.length;i<r;++i)t[i]+=e[i];return t}throw"Bad input shape"}function n(t,e){for(var i=0,r=t.length;i<r;++i)t[i]+=e;return t}function a(t,e){if(t.length===e.length){for(var i=0,r=t.length;i<r;++i)t[i]-=e[i];return t}throw"Bad input shape"}function h(t,e){for(var i=0,r=t.length;i<r;++i)t[i]-=e;return t}function u(t,e){if(t.length===e.length){for(var i=0,r=t.length;i<r;++i)t[i]*=e[i];return t}throw"Bad input shape"}function p(t,e){for(var i=0,r=t.length;i<r;++i)t[i]*=e;return t}function d(t,e){if(t.length===e.length){for(var i=0,r=t.length;i<r;++i)t[i]/=e[i];return t}throw"Bad input shape"}function c(t,e){for(var i=0,r=t.length;i<r;++i)t[i]/=e;return t}function f(t,e,i){if(t.length===e.length){for(var r=0,s=t.length;r<s;++r)t[r]+=i*e[r];return t}throw"Bad input shape"}t.DEFAULT_TYPE_INSTANCE=Float32Array,t.zeros=e,t.fill=i,t.prod=r,t.sum=s,t.add=o,t.addConst=n,t.sub=a,t.subConst=h,t.mul=u,t.mulByConst=p,t.div=d,t.divByConst=c,t.addScaled=f}(NumJS||(NumJS={}));var NumJS;!function(t){function e(t){for(var e=Number.NEGATIVE_INFINITY,i=0,r=t.length;i<r;++i)t[i]>e&&(e=t[i]);return e}function i(t){for(var e=Number.NEGATIVE_INFINITY,i=0,r=0,s=t.length;r<s;++r)t[r]>e&&(e=t[r],i=r);return i}function r(t,e){return e=e||3,t.slice(0).sort(function(t,e){return e-t}).slice(0,e)}function s(t,e){e=e||3;for(var i=t.length,r=new Uint32Array(i),s=0;s<i;++s)r[s]=s;return r.sort(function(e,i){return t[i]-t[e]}).slice(0,e)}function o(t){if(0===t.length)return{};for(var e=t[0],i=t[0],r=0,s=0,o=1,n=t.length;o<n;++o)t[o]>e&&(e=t[o],r=o),t[o]<i&&(i=t[o],s=o);return{maxi:r,maxv:e,mini:s,minv:i,dv:e-i}}t.max=e,t.argmax=i,t.maxn=r,t.argmaxn=s,t.maxmin=o}(NumJS||(NumJS={}));var NumJS;!function(t){function e(){if(n)return n=!1,a;var t=2*Math.random()-1,i=2*Math.random()-1,r=t*t+i*i;if(0==r||r>1)return e();var s=Math.sqrt(-2*Math.log(r)/r);return a=i*s,n=!0,t*s}function i(t,e){return Math.random()*(e-t)+t}function r(t,e){return Math.floor(Math.random()*(e-t)+t)}function s(t,i){return t+e()*i}function o(t){for(var e,i=t,r=0,s=[],o=0;o<t;++o)s[o]=o;for(;i--;)r=Math.floor(Math.random()*(i+1)),e=s[i],s[i]=s[r],s[r]=e;return s}var n=!1,a=0;t.gaussRandom=e,t.randf=i,t.randi=r,t.randn=s,t.randperm=o}(NumJS||(NumJS={}));var NumJS;!function(t){function e(t,e,i){return Math.max(Math.min(t,i),e)}function i(t,e){return(t%e+e)%e}function r(t){var e=Math.exp(2*t);return(e-1)/(e+1)}t.clip=e,t.mod=i,t.tanh=r}(NumJS||(NumJS={}));var Net;!function(t){var e=NumJS,i=function(){function t(t,i,r,s){this.sx=t,this.sy=i,this.depth=r;var o=this.sx*this.sy*this.depth;if(this.w=e.zeros(o),this.dw=e.zeros(o),void 0===s)for(var n=Math.sqrt(1/o),a=0;a<o;++a)this.w[a]=e.randn(0,n);else 0!==s&&e.fill(this.w,s)}return t.fromArray=function(e){var i=new t(1,1,e.length,0);return i.w.set(e),i},t.prototype.clone=function(){var e=new t(this.sx,this.sy,this.depth,0);return e.w.set(this.w),e},t.prototype.cloneAndZero=function(){var e=new t(this.sx,this.sy,this.depth,0);return e},t.prototype.get=function(t,e,i){var r=(this.sx*e+t)*this.depth+i;return this.w[r]},t.prototype.set=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;this.w[s]=r},t.prototype.add=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;return this.w[s]+=r,this},t.prototype.sub=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;return this.w[s]-=r,this},t.prototype.mul=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;return this.w[s]*=r,this},t.prototype.div=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;return this.w[s]/=r,this},t.prototype.get_grad=function(t,e,i){var r=(this.sx*e+t)*this.depth+i;return this.dw[r]},t.prototype.set_grad=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;this.dw[s]=r},t.prototype.add_grad=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;this.dw[s]+=r},t.prototype.sub_grad=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;this.dw[s]-=r},t.prototype.mul_grad=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;this.dw[s]*=r},t.prototype.div_grad=function(t,e,i,r){var s=(this.sx*e+t)*this.depth+i;this.dw[s]/=r},t.prototype.roll=function(t,i,r){void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=0);for(var s=this.clone(),o=0,n=s.depth;o<n;++o)for(var a=0,h=s.sx;a<h;++a)for(var u=0,p=s.sy;u<p;++u){var d=this.get(e.mod(a+t,this.sx),e.mod(u+i,this.sy),e.mod(o+r,this.depth));s.set(a,u,o,d)}return s},t.prototype.zoom=function(e,i,r){void 0===e&&(e=1),void 0===i&&(i=1),void 0===r&&(r=1);for(var s=new t(Math.round(this.sx*e),Math.round(this.sy*i),Math.round(this.depth*r),0),o=0,n=s.depth;o<n;++o)for(var a=0,h=s.sx;a<h;++a)for(var u=0,p=s.sy;u<p;++u){for(var d=0,c=Math.ceil(1/e),f=Math.ceil(1/i),_=Math.ceil(1/r),l=Math.ceil(a/e),y=Math.ceil(u/i),v=Math.ceil(o/r),m=Math.min(l+c,this.sx),g=Math.min(y+f,this.sy),w=Math.min(v+_,this.depth),x=l;x<m;x++)for(var N=y;N<g;N++)for(var S=v;S<w;S++){var b=this.get(x,N,S);s.add(a,u,o,b),d++}s.div(a,u,o,d)}return s},t.prototype.toJSON=function(){var t={};return t.sx=this.sx,t.sy=this.sy,t.depth=this.depth,t.w=this.w,t},t.fromJSON=function(e){var i=new t(e.sx,e.sy,e.depth,0);return i.w.set(e.w),i},t}();t.Vol=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(){function t(){}return t.prototype.getLayer=function(t){return this.layers.get(t)},t.prototype.setInputDimensions=function(t,e,i){void 0===i&&(i=3),this.layerIterator(function(r,s,o){0===s?(r.in_sx=t,r.in_sy=e,r.in_depth=i,r.updateDimensions()):r.updateDimensions(o)})},t.prototype.layerIterator=function(t,e){var i=this;void 0===e&&(e={});var r,s=[],o=[],n=0,a=d3.set();void 0===e.reverse||e.reverse===!1?(r=e.start?this.layers.get(e.start):this.layers.get("data"),o=this.edges):(r=e.start?this.layers.get(e.start):this.layers.values()[this.layers.size()-1],o=this.edges.map(function(t){return{from:t.to,to:t.from}}));var h=d3.map(d3.nest().key(function(t){return t.from}).entries(o),function(t){return t.key}),u=d3.map(d3.nest().key(function(t){return t.to}).entries(o),function(t){return t.key});for(s.push(r);s.length;){var p=s.pop();a.add(p.name);var d=u.get(p.name),c=void 0===d?void 0:d.values.map(function(t){return i.layers.get(t.from)});if(t(p,n++,c),e.end&&p.name===e.end)break;var f=h.get(p.name);f&&f.values.filter(function(t){return!a.has(t.to)}).forEach(function(t){var e=u.get(t.to),r=void 0===e?[]:e.values.filter(function(t){return!a.has(t.from)});0===r.length&&s.push(i.layers.get(t.to))})}},t.prototype.forward=function(t,e,i){void 0===e&&(e=!1),void 0===i&&(i={});var r,s=d3.map();return this.layerIterator(function(i,o,n){r=void 0===n?t:n.length>1?n.map(function(t){return s.get(t.name)}):s.get(n[0].name),r=i.forward(r,e),s.set(i.name,r)},i),r},t.prototype.backward=function(t,e){void 0===e&&(e={}),e.reverse=!0;var i;return this.layerIterator(function(e,r,s){void 0!==t&&0===r?i=e.backward(t):e.backward()},e),i},t.prototype.debugStructure=function(){var t=0,i=d3.format("s"),r=d3.format(",d"),s=0;this.layerIterator(function(i,o,n){var a=e.sum(i.getNumParameters()),h="";h+=i.getOutputShape().join("x")+" :: ",h+=i.getDescription().join(" "),a&&(t+=a,h+=" => "+r(a)+" parameters"),s+=1,console.log(h)}),console.log("---"),console.log("Total number of layers "+r(s)),console.log("Total number of params "+r(t)+" (memory: "+i(4*t)+"b): ")},t}();t.Net=i}(Net||(Net={}));var Parser;!function(t){var e=function(){function t(){}return t.prototype.fetch=function(t){var e=new Request(t);return fetch(e).then(function(t){return t.text()})},t.prototype.parse=function(t){var e=this;return this.fetch(t).then(function(t){return e.parseString(t)})},t}();t.BaseParser=e}(Parser||(Parser={}));var Parser;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.parseString=function(t){return this.parsePrototxt(t)},e.prototype.parsePrototxt=function(t,e){void 0===e&&(e=0);var i,r={};if(0==e)var s=/(?:^|\n)(\w+):\s"*([\w\/.]+)"*/gi,o=/(?:^|\n)(\w+)\s\{([\S\s]*?)\n\}/gi;else var n="(?:^|\\n)\\s{"+e+"}",a="(\\w+)",s=new RegExp(n+a+'\\s*:\\s*"*([\\w/.]+)"*',"gi"),o=new RegExp(n+a+"\\s*\\{\\s*\\n([\\s\\S]*?)\\n\\s{"+e+"}\\}","gi");for(;i=s.exec(t);){var a=i[1],h=i[2];void 0!==r[a]?Array.isArray(r[a])?r[a].push(h):(r[a]=[r[a]],r[a].push(h)):r[i[1]]=h}for(;i=o.exec(t);){var a=i[1],h=this.parsePrototxt(i[2],e+2);void 0!==r[a]?Array.isArray(r[a])?r[a].push(h):(r[a]=[r[a]],r[a].push(h)):r[a]=h}return r},e}(t.BaseParser);t.PrototxtParser=e}(Parser||(Parser={}));var Net;!function(t){function e(t,e){for(var i=n.randf(0,1),r=0,s=0,o=t.length;s<o;s++)if(r+=e[s],i<r)return t[s]}function i(t,e,i){if(void 0===t&&(t={}),"string"==typeof e)return void 0!==t[e]?t[e]:i;var r=i;return e.forEach(function(e){r=void 0!==t[e]?t[e]:r}),r}function r(t,e){if(!t){if(e=e||"Assertion failed","undefined"!=typeof Error)throw new Error(e);throw e}}function s(t,e){for(var i=0,r=t.length;i<r;i++)if(t[i]===e)return!0;return!1}function o(t){for(var e=[],i=0,r=t.length;i<r;i++)s(e,t[i])||e.push(t[i]);return e}var n=NumJS;t.weightedSample=e,t.getopt=i,t.assert=r,t.arrContains=s,t.arrUnique=o}(Net||(Net={}));var Net;!function(t){var e=function(){function t(t){this.in_depth=1,this.in_sy=1,this.in_sx=1,this.out_depth=1,this.out_sy=1,this.out_sx=1,this.name=void 0!==t.name?t.name:"",this.input=void 0!==t.input?t.input:void 0,this.output=void 0!==t.output?t.output:void 0,t.pred||(this.in_sx=t.in_sx,this.in_sy=t.in_sy,this.in_depth=t.in_depth)}return t.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.out_sx=this.in_sx,this.out_sy=this.in_sy,this.out_depth=this.in_depth},t.prototype.getNumParameters=function(){return[0,0]},t.prototype.getOutputShape=function(){return[this.in_depth,this.in_sy,this.in_sx]},t.prototype.getDescription=function(){return[this.layer_type.toUpperCase(),this.name]},t.prototype.getParamsAndGrads=function(){return[]},t.prototype.toJSON=function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.name=this.name,t.output=this.output,t.input=this.input,t},t.prototype.fromJSON=function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.name=t.name,this.output=t.output,this.input=t.input},t}();t.BaseLayer=e}(Net||(Net={}));var Net;!function(t){var e=function(e){function i(i){e.call(this,i||{}),this.layer_type="input",this.in_depth=t.getopt(i,["in_depth","out_depth","depth"],0),this.in_sx=t.getopt(i,["in_sx","out_sx","sx","width"],1),this.in_sy=t.getopt(i,["in_sy","out_sy","sy","height"],1),this.updateDimensions()}return __extends(i,e),i.prototype.forward=function(t,e){return this.in_act=t,this.out_act=t,this.out_act},i.prototype.backward=function(){},i}(t.BaseLayer);t.InputLayer=e}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(i){function r(e){i.call(this,e||{}),this.layer_type="concat",this.axis=t.getopt(e,["axis"],1),this.updateDimensions(e.pred)}return __extends(r,i),r.prototype.forward=function(e,i){this.in_act=e;var r=new t.Vol(this.out_sx,this.out_sy,this.out_depth,0),s=0;if(0===this.axis)for(var o=r.w,n=0;n<e.length;n++)o.set(e[n].w,s),s+=e[n].w.length;else for(var n=0;n<e.length;n++){for(var a=e[n],h=0;h<a.depth;h++)for(var u=0;u<a.sx;u++)for(var p=0;p<a.sy;p++)r.set(u,p,h+s,a.get(u,p,h));s+=a.depth}return this.out_act=r,this.out_act},r.prototype.backward=function(){var t=this.in_act,e=this.out_act,i=0;if(0===this.axis)for(var r=e.dw,s=0,o=t.length;s<o;++s){var n=t[s].dw;r.set(n,i),i+=n.length}else for(var s=0,o=t.length;s<o;++s){for(var a=t[s],h=0,u=a.depth;h<u;++h)for(var p=0,d=a.sx;p<d;++p)for(var c=0,f=a.sy;c<f;++c)a.set_grad(p,c,h,e.get_grad(p,c,h+i));i+=a.depth}},r.prototype.updateDimensions=function(t){t&&(0==this.axis?(this.in_sx=t[0].in_sx,this.in_sy=t[0].in_sy,this.in_depth=t[0].in_depth):(this.in_sx=t[0].in_sx,this.in_sy=t[0].in_sy,this.in_depth=e.sum(t.map(function(t){return t.out_depth})))),this.out_sx=this.in_sx,this.out_sy=this.in_sy,this.out_depth=this.in_depth},r.prototype.toJSON=function(){var t=i.prototype.toJSON.call(this);return t.axis=this.axis,t},r.prototype.fromJSON=function(t){i.prototype.fromJSON.call(this,t),this.axis=t.axis},r}(t.BaseLayer);t.ConcatLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(i){function r(e){i.call(this,e||{}),this.layer_type="conv",this.out_depth=e.filters,this.sx=e.sx,this.sy=t.getopt(e,["sy"],this.sx),this.stride=t.getopt(e,["stride"],1),this.pad=t.getopt(e,["pad"],0),this.l1_decay_mul=t.getopt(e,["l1_decay_mul"],0),this.l2_decay_mul=t.getopt(e,["l2_decay_mul"],1),this.updateDimensions(e.pred);var r=t.getopt(e,["bias_pref"],0);this.biases=new t.Vol(1,1,this.out_depth,r),this.filters=[];for(var s=0;s<this.out_depth;++s)this.filters.push(new t.Vol(this.sx,this.sy,this.in_depth,0))}return __extends(r,i),r.prototype.forward=function(e,i){this.in_act=e;for(var r=new t.Vol(0|this.out_sx,0|this.out_sy,0|this.out_depth,0),s=0|e.sx,o=0|e.sy,n=0|this.stride,a=0;a<this.out_depth;++a)for(var h=this.filters[a],u=0|-this.pad,p=0|-this.pad,d=0;d<this.out_sy;p+=n,++d){u=0|-this.pad;for(var c=0;c<this.out_sx;u+=n,++c){for(var f=0,_=0;_<h.sy;++_)for(var l=p+_,y=0;y<h.sx;++y){var v=u+y;if(l>=0&&l<o&&v>=0&&v<s)for(var m=0;m<h.depth;++m)f+=h.w[(h.sx*_+y)*h.depth+m]*e.w[(s*l+v)*e.depth+m]}f+=this.biases.w[a],r.set(c,d,a,f)}}return this.out_act=r,this.out_act},r.prototype.backward=function(){var t=this.in_act;t.dw=e.zeros(t.w.length);for(var i=0|t.sx,r=0|t.sy,s=0|this.stride,o=0;o<this.out_depth;++o)for(var n=this.filters[o],a=0|-this.pad,h=0|-this.pad,u=0;u<this.out_sy;h+=s,++u){a=0|-this.pad;for(var p=0;p<this.out_sx;a+=s,++p){for(var d=this.out_act.get_grad(p,u,o),c=0;c<n.sy;++c)for(var f=h+c,_=0;_<n.sx;++_){var l=a+_;if(f>=0&&f<r&&l>=0&&l<i)for(var y=0;y<n.depth;++y){var v=(i*f+l)*t.depth+y,m=(n.sx*c+_)*n.depth+y;n.dw[m]+=t.w[v]*d,t.dw[v]+=n.w[m]*d}}this.biases.dw[o]+=d}}},r.prototype.getParamsAndGrads=function(){for(var t=[],e=0;e<this.out_depth;e++)t.push({params:this.filters[e].w,grads:this.filters[e].dw,l2_decay_mul:this.l2_decay_mul,l1_decay_mul:this.l1_decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0}),t},r.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.out_sx=Math.round((this.in_sx+2*this.pad-this.sx)/this.stride+1),this.out_sy=Math.round((this.in_sy+2*this.pad-this.sy)/this.stride+1)},r.prototype.getNumParameters=function(){return[this.in_depth*this.sx*this.sy*this.out_depth,this.out_depth]},r.prototype.getOutputShape=function(){return[this.out_depth,Math.ceil((this.in_sy+2*this.pad-this.sy+1+this.stride-1)/this.stride),Math.ceil((this.in_sx+2*this.pad-this.sx+1+this.stride-1)/this.stride)]},r.prototype.getDescription=function(){return i.prototype.getDescription.call(this).concat([[this.out_depth,this.sy,this.sx].join("x")+" Stride "+this.stride+" Pad "+this.pad])},r.prototype.toJSON=function(){var t=i.prototype.toJSON.call(this);t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.in_depth=this.in_depth,t.l1_decay_mul=this.l1_decay_mul,t.l2_decay_mul=this.l2_decay_mul,t.pad=this.pad,t.filters=[];for(var e=0;e<this.filters.length;e++)t.filters.push(this.filters[e].toJSON());return t.biases=this.biases.toJSON(),t},r.prototype.fromJSON=function(e){i.prototype.fromJSON.call(this,e),this.sx=e.sx,this.sy=e.sy,this.stride=e.stride,this.in_depth=e.in_depth,this.filters=[],this.l1_decay_mul=void 0!==e.l1_decay_mul?e.l1_decay_mul:0,this.l2_decay_mul=void 0!==e.l2_decay_mul?e.l2_decay_mul:1,this.pad=void 0!==e.pad?e.pad:0;for(var r=0;r<e.filters.length;r++)this.filters.push(t.Vol.fromJSON(e.filters[r]));this.biases=t.Vol.fromJSON(e.biases)},r}(t.BaseLayer);t.ConvLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(i){function r(e){i.call(this,e||{}),this.layer_type="pool",this.out_depth=e.filters,this.sx=e.sx,this.pool=t.getopt(e,["pool"],"MAX"),this.sy=t.getopt(e,["sy"],this.sx),this.stride=t.getopt(e,["stride"],1),this.pad=t.getopt(e,["pad"],0),this.updateDimensions(e.pred)}return __extends(r,i),r.prototype.forward=function(i,r){this.in_act=i,this.switchx=e.zeros(this.out_sx*this.out_sy*this.out_depth),this.switchy=e.zeros(this.out_sx*this.out_sy*this.out_depth);var s=new t.Vol(this.out_sx,this.out_sy,this.out_depth,0);if("AVE"===this.pool)for(var o=(this.sx*this.sy,0);o<this.out_depth;++o)for(var n=0;n<this.out_sx;++n)for(var a=0;a<this.out_sy;++a){for(var h=0,u=n*this.stride-this.pad,p=a*this.stride-this.pad,d=Math.min(u+this.sx,this.out_sx+this.pad),c=Math.min(p+this.sy,this.out_sy+this.pad),f=(d-u)*(c-p),_=u;_<d;++_)for(var l=p;l<c;++l)h+=i.get(_,l,o);s.set(n,a,o,h/f)}else for(var y=0,v=0;v<this.out_depth;++v)for(var m=-this.pad,g=-this.pad,w=0;w<this.out_sx;m+=this.stride,w++){g=-this.pad;for(var x=0;x<this.out_sy;g+=this.stride,x++){for(var N=-99999,S=-1,b=-1,J=0;J<this.sx;++J)for(var O=0;O<this.sy;++O){var M=g+O,L=m+J;if(M>=0&&M<i.sy&&L>=0&&L<i.sx){var A=i.get(L,M,v);A>N&&(N=A,S=L,b=M)}}this.switchx[y]=S,this.switchy[y]=b,y++,s.set(w,x,v,N)}}return this.out_act=s,this.out_act},r.prototype.backward=function(){var t=this.in_act;t.dw=e.zeros(t.w.length);this.out_act;if("AVE"===this.pool);else for(var i=0,r=0;r<this.out_depth;++r)for(var s=-this.pad,o=0;o<this.out_sx;s+=this.stride,o++)for(var n=-this.pad,a=0;a<this.out_sy;n+=this.stride,a++){var h=this.out_act.get_grad(o,a,r);t.add_grad(this.switchx[i],this.switchy[i],r,h),i++}},r.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.out_sx=Math.round((this.in_sx+2*this.pad-this.sx)/this.stride+1),this.out_sy=Math.round((this.in_sy+2*this.pad-this.sy)/this.stride+1),this.out_depth=this.in_depth},r.prototype.getOutputShape=function(){return[this.out_depth,Math.ceil((this.in_sy+2*this.pad-this.sy+1+this.stride-1)/this.stride),Math.ceil((this.in_sx+2*this.pad-this.sx+1+this.stride-1)/this.stride)]},r.prototype.getDescription=function(){return[this.pool+" "+this.layer_type.toUpperCase(),this.name,[this.sy,this.sx].join("x")+" Stride "+this.stride+" Pad "+this.pad]},r.prototype.toJSON=function(){var t=i.prototype.toJSON.call(this);return t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.pool=this.pool,t.in_depth=this.in_depth,t.pad=this.pad,t},r.prototype.fromJSON=function(t){i.prototype.fromJSON.call(this,t),this.pool=void 0!==t.pool?t.pool:"MAX",this.sx=t.sx,this.sy=t.sy,this.stride=t.stride,this.in_depth=t.in_depth,this.pad=void 0!==t.pad?t.pad:0,this.switchx=e.zeros(this.out_sx*this.out_sy*this.out_depth,Uint32Array),this.switchy=e.zeros(this.out_sx*this.out_sy*this.out_depth,Uint32Array)},r}(t.BaseLayer);t.PoolLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(i){function r(e){i.call(this,e||{}),this.layer_type="fc",this.sx=1,this.sy=1,this.out_depth=void 0!==e.num_neurons?e.num_neurons:e.filters,this.l1_decay_mul=t.getopt(e,["l1_decay_mul"],0),this.l2_decay_mul=t.getopt(e,["l2_decay_mul"],1),this.updateDimensions(e.pred);var r=t.getopt(e,["bias_pref"],0);this.biases=new t.Vol(1,1,this.out_depth,r),this.filters=[];for(var s=0;s<this.out_depth;++s)this.filters.push(new t.Vol(1,1,this.num_inputs,0));if(void 0!==e.filters)for(var s=0;s<this.out_depth;++s)this.filters[s].w.set(e.filters[s]);void 0!==e.biases&&this.biases.w.set(e.biases)}return __extends(r,i),r.prototype.forward=function(e,i){this.in_act=e;for(var r=new t.Vol(1,1,this.out_depth,0),s=e.w,o=0;o<this.out_depth;++o){for(var n=0,a=this.filters[o].w,h=0;h<this.num_inputs;++h)n+=s[h]*a[h];n+=this.biases.w[o],r.w[o]=n}return this.out_act=r,this.out_act},r.prototype.backward=function(){var t=this.in_act;t.dw=e.zeros(t.w.length);for(var i=0;i<this.out_depth;++i){for(var r=this.filters[i],s=this.out_act.dw[i],o=0;o<this.num_inputs;++o)t.dw[o]+=r.w[o]*s,r.dw[o]+=t.w[o]*s;this.biases.dw[i]+=s}},r.prototype.getParamsAndGrads=function(){for(var t=[],e=0;e<this.out_depth;++e)t.push({params:this.filters[e].w,grads:this.filters[e].dw,l1_decay_mul:this.l1_decay_mul,l2_decay_mul:this.l2_decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0}),t},r.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth},r.prototype.getNumParameters=function(){return[this.in_depth*this.in_sx*this.in_sy*this.out_depth,this.out_depth]},r.prototype.getOutputShape=function(){return[this.out_depth,1,1]},r.prototype.toJSON=function(){var t=i.prototype.toJSON.call(this);t.num_inputs=this.num_inputs,t.l1_decay_mul=this.l1_decay_mul,t.l2_decay_mul=this.l2_decay_mul,t.filters=[];for(var e=0;e<this.filters.length;e++)t.filters.push(this.filters[e].toJSON());return t.biases=this.biases.toJSON(),t},r.prototype.fromJSON=function(e){i.prototype.fromJSON.call(this,e),this.num_inputs=e.num_inputs,this.l1_decay_mul=void 0!==e.l1_decay_mul?e.l1_decay_mul:1,this.l2_decay_mul=void 0!==e.l2_decay_mul?e.l2_decay_mul:1,this.filters=[];for(var r=0;r<e.filters.length;r++)this.filters.push(t.Vol.fromJSON(e.filters[r]));this.biases=t.Vol.fromJSON(e.biases)},r}(t.BaseLayer);t.FullyConnectedLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(i){function r(e){i.call(this,e||{}),this.layer_type="dropout",this.drop_prob=t.getopt(e,["drop_prob"],.5),this.updateDimensions(e.pred)}return __extends(r,i),r.prototype.forward=function(t,i){void 0===i&&(i=!1),this.in_act=t,this.dropped=e.zeros(this.out_sx*this.out_sy*this.out_depth,Int8Array);var r=t.clone(),s=t.w.length;if(i)for(var o=0;o<s;o++)Math.random()<this.drop_prob&&(r.w[o]=0,this.dropped[o]=1);else for(var o=0;o<s;o++)r.w[o]*=this.drop_prob;return this.out_act=r,this.out_act},r.prototype.backward=function(){var t=this.in_act,i=this.out_act,r=t.w.length;t.dw=e.zeros(r);for(var s=0;s<r;s++)1!==this.dropped[s]&&(t.dw[s]=i.dw[s])},r.prototype.toJSON=function(){var t=i.prototype.toJSON.call(this);return t.drop_prob=this.drop_prob,t},r.prototype.fromJSON=function(t){i.prototype.fromJSON.call(this,t),this.drop_prob=t.drop_prob},r}(t.BaseLayer);t.DropoutLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(t){function i(e){t.call(this,e||{}),this.layer_type="tanh",this.updateDimensions(e.pred)}return __extends(i,t),i.prototype.forward=function(t,i){this.in_act=t;for(var r=t.cloneAndZero(),s=t.w.length,o=0;o<s;o++)r.w[o]=e.tanh(t.w[o]);return this.out_act=r,this.out_act},i.prototype.backward=function(){var t=this.in_act,i=this.out_act,r=t.w.length;t.dw=e.zeros(r);for(var s=0;s<r;s++){var o=i.w[s];t.dw[s]=(1-o*o)*i.dw[s]}},i}(t.BaseLayer);t.TanhLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(i){function r(t){i.call(this,t||{}),this.layer_type="maxout",this.group_size=void 0!==t.group_size?t.group_size:2,this.updateDimensions(t.pred)}return __extends(r,i),r.prototype.forward=function(i,r){this.in_act=i,this.switches=e.zeros(this.out_sx*this.out_sy*this.out_depth,Uint32Array);var s=this.out_depth,o=new t.Vol(this.out_sx,this.out_sy,this.out_depth,0);if(1===this.out_sx&&1===this.out_sy)for(var n=0;n<s;n++){for(var a=n*this.group_size,h=i.w[a],u=0,p=1;p<this.group_size;p++){var d=i.w[a+p];d>h&&(h=d,u=p)}o.w[n]=h,this.switches[n]=a+u}else for(var c=0,f=0;f<i.sx;f++)for(var _=0;_<i.sy;_++)for(var n=0;n<s;n++){for(var a=n*this.group_size,h=i.get(f,_,a),u=0,p=1;p<this.group_size;p++){var d=i.get(f,_,a+p);d>h&&(h=d,u=p)}o.set(f,_,n,h),this.switches[c]=a+u,c++}return this.out_act=o,this.out_act},r.prototype.backward=function(){var t=this.in_act,i=this.out_act,r=this.out_depth;if(t.dw=e.zeros(t.w.length),1===this.out_sx&&1===this.out_sy)for(var s=0;s<r;s++){var o=i.dw[s];t.dw[this.switches[s]]=o}else for(var n=0,a=0;a<i.sx;a++)for(var h=0;h<i.sy;h++)for(var s=0;s<r;s++){var o=i.get_grad(a,h,s);t.set_grad(a,h,this.switches[n],o),n++}},r.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.out_sx=this.in_sx,this.out_sy=this.in_sy,this.out_depth=Math.floor(this.in_depth/this.group_size)},r.prototype.toJSON=function(){var t=i.prototype.toJSON.call(this);return t.group_size=this.group_size,t},r.prototype.fromJSON=function(t){i.prototype.fromJSON.call(this,t),this.group_size=t.group_size},r}(t.BaseLayer);t.MaxoutLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(t){function i(e){t.call(this,e||{}),this.layer_type="relu",this.updateDimensions(e.pred)}return __extends(i,t),i.prototype.forward=function(t,e){this.in_act=t;for(var i=t.clone(),r=t.w.length,s=i.w,o=0;o<r;o++)s[o]<0&&(s[o]=0);return this.out_act=i,this.out_act},i.prototype.backward=function(){var t=this.in_act,i=this.out_act,r=t.w.length;t.dw=e.zeros(r);for(var s=0;s<r;s++)i.w[s]<=0?t.dw[s]=0:t.dw[s]=i.dw[s]},i}(t.BaseLayer);t.ReluLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(t){function i(e){t.call(this,e||{}),this.layer_type="sigmoid",this.updateDimensions(e.pred)}return __extends(i,t),i.prototype.forward=function(t,e){this.in_act=t;for(var i=t.cloneAndZero(),r=t.w.length,s=i.w,o=t.w,n=0;n<r;n++)s[n]=1/(1+Math.exp(-o[n]));return this.out_act=i,this.out_act},i.prototype.backward=function(){var t=this.in_act,i=this.out_act,r=t.w.length;t.dw=e.zeros(r);for(var s=0;s<r;s++){var o=i.w[s];t.dw[s]=o*(1-o)*i.dw[s]}},i}(t.BaseLayer);t.SigmoidLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(t){function i(e){t.call(this,e||{}),this.layer_type="regression",this.updateDimensions(e.pred)}return __extends(i,t),i.prototype.forward=function(t,e){return this.in_act=t,this.out_act=t,t},i.prototype.backward=function(t){var i=this.in_act;i.dw=e.zeros(i.w.length);var r=0;if(t instanceof Float32Array)for(var s=0;s<this.out_depth;s++){var o=i.w[s]-t[s];i.dw[s]=o,r+=.5*o*o}else if("number"==typeof t){var o=i.w[0]-t;i.dw[0]=o,r+=.5*o*o}else{var s=t.dim,n=t.val,o=i.w[s]-n;i.dw[s]=o,r+=.5*o*o}return r},i.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth,this.out_depth=this.num_inputs},i.prototype.getOutputShape=function(){return[this.out_depth,1,1]},i.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.num_inputs=this.num_inputs,e},i.prototype.fromJSON=function(e){t.prototype.fromJSON.call(this,e),this.num_inputs=e.num_inputs},i}(t.BaseLayer);t.RegressionLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(i){function r(t){i.call(this,t||{}),this.layer_type="softmax",this.updateDimensions(t.pred)}return __extends(r,i),r.prototype.forward=function(i,r){this.in_act=i;for(var s=new t.Vol(1,1,this.out_depth,0),o=i.w,n=i.w[0],a=1;a<this.out_depth;a++)o[a]>n&&(n=o[a]);for(var h=e.zeros(this.out_depth),u=0,a=0;a<this.out_depth;a++){var p=Math.exp(o[a]-n);u+=p,h[a]=p}for(var a=0;a<this.out_depth;a++)h[a]/=u,s.w[a]=h[a];return this.es=h,this.out_act=s,this.out_act},r.prototype.backward=function(t){var i=this.in_act;i.dw=e.zeros(i.w.length);for(var r=0;r<this.out_depth;r++){var s=r===t?1:0,o=-(s-this.es[r]);i.dw[r]=o}return-Math.log(this.es[t])},r.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth,this.out_depth=this.num_inputs},r.prototype.getOutputShape=function(){return[this.out_depth,1,1]},r.prototype.toJSON=function(){var t=i.prototype.toJSON.call(this);return t.num_inputs=this.num_inputs,t},r.prototype.fromJSON=function(t){i.prototype.fromJSON.call(this,t),this.num_inputs=t.num_inputs},r}(t.BaseLayer);t.SoftmaxLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(t){function i(e){t.call(this,e||{}),this.layer_type="svm",this.updateDimensions(e.pred)}return __extends(i,t),i.prototype.forward=function(t,e){return this.in_act=t,this.out_act=t,t},i.prototype.backward=function(t){var i=this.in_act;i.dw=e.zeros(i.w.length);for(var r=i.w[t],s=1,o=0,n=0;n<this.out_depth;n++)if(t!==n){var a=-r+i.w[n]+s;a>0&&(i.dw[n]+=1,i.dw[t]-=1,o+=a)}return o},i.prototype.updateDimensions=function(t){t&&(this.in_sx=t[0].out_sx,this.in_sy=t[0].out_sy,this.in_depth=t[0].out_depth),this.num_inputs=this.in_sx*this.in_sy*this.in_depth,this.out_depth=this.num_inputs},i.prototype.getOutputShape=function(){return[this.out_depth,1,1]},i.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.num_inputs=this.num_inputs,e},i.prototype.fromJSON=function(e){t.prototype.fromJSON.call(this,e),this.num_inputs=e.num_inputs},i}(t.BaseLayer);t.SVMLayer=i}(Net||(Net={}));var Net;!function(t){var e=NumJS,i=function(t){function i(e){t.call(this,e||{}),this.layer_type="lrn",this.k=e.k,this.n=e.n,this.alpha=e.alpha,this.beta=e.beta,this.n%2===0&&console.warn("WARNING n should be odd for LRN layer"),this.updateDimensions(e.pred)}return __extends(i,t),i.prototype.forward=function(t,e){this.in_act=t;var i=t.cloneAndZero();this.S_cache_=t.cloneAndZero();for(var r=Math.floor(this.n/2),s=0;s<t.sx;s++)for(var o=0;o<t.sy;o++)for(var n=0;n<t.depth;n++){for(var a=t.get(s,o,n),h=this.k,u=this.alpha/this.n,p=0,d=Math.max(0,n-r);d<=Math.min(n+r,t.depth-1);d++){var c=t.get(s,o,d);p+=c*c}var f=h+u*p;this.S_cache_.set(s,o,n,f);var _=a*Math.pow(f,-this.beta);i.set(s,o,n,_)}return this.out_act=i,this.out_act},i.prototype.backward=function(){var t=this.in_act;t.dw=e.zeros(t.w.length);for(var i=this.out_act,r=Math.floor(this.n/2),s=0;s<t.sx;s++)for(var o=0;o<t.sy;o++)for(var n=0;n<t.depth;n++){for(var a=this.S_cache_.get(s,o,n),h=t.get(s,o,n),u=i.get_grad(s,o,n),p=Math.pow(a,-this.beta)*u,d=2*this.alpha*this.beta/this.n*h,c=0,f=Math.max(0,n-r);f<=Math.min(n+r,t.depth-1);f++){var _=i.get(s,o,f),l=i.get_grad(s,o,f),y=this.S_cache_.get(s,o,f);c+=l*_/y}var v=p-d*c;t.set_grad(s,o,n,v)}},i.prototype.getDescription=function(){return t.prototype.getDescription.call(this).concat(["alpha "+this.alpha,"beta "+this.beta,"k "+this.k,"n "+this.n])},i.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.k=this.k,e.n=this.n,e.alpha=this.alpha,e.beta=this.beta,e},i.prototype.fromJSON=function(e){t.prototype.fromJSON.call(this,e),this.k=e.k,this.n=e.n,this.alpha=e.alpha,this.beta=e.beta},i}(t.BaseLayer);t.LocalResponseNormalizationLayer=i}(Net||(Net={}));var Net;!function(t){var e=function(e){function i(t,i){e.call(this),this.modelPath=t,this.weightPath=i}return __extends(i,e),i.prototype.load=function(){var t=this;return this.fetch(this.modelPath).then(function(e){return t.create(e)}).then(function(e){return t.loadWeights()})},i.prototype.fetch=function(t){var e=new Parser.PrototxtParser;return e.parse(t)},i.prototype.create=function(t){this.name=t.name,this.createLayers(t,t.layer||t.layers,"data"===t.input),this.createEdges()},i.prototype.caffeLayerToJs=function(e){var i,r=this,s={name:e.name,input:e.bottom,output:e.top};switch(void 0!==e.bottom&&(Array.isArray(e.bottom)?s.pred=e.bottom.map(function(t){return r.layers.get(t)}):s.pred=[this.layers.get(e.bottom)]),e.type.toLowerCase()){case"input":var o=e.input_param||{};s.out_depth=+o.shape.dim[1],s.out_sx=+o.shape.dim[2],s.out_sy=+o.shape.dim[3],i=new t.InputLayer(s);break;case"conv":case"convolution":var o=e.param||{},n=e.convolution_param||{};s.sx=void 0!==n.kernel_size?+n.kernel_size:void 0,s.filters=void 0!==n.num_output?+n.num_output:void 0,s.pad=void 0!==n.pad?+n.pad:void 0,s.stride=void 0!==n.stride?+n.stride:void 0,s.l1_decay_mul=o&&o.length&&void 0!==o[0].decay_mult?+o[0].decay_mult:0,s.l2_decay_mul=o&&o.length&&void 0!==o[1].decay_mult?+o[1].decay_mult:1,
i=new t.ConvLayer(s);break;case"lrn":var o=e.lrn_param||{};s.k=void 0!==o.k?+o.k:1,s.n=void 0!==o.local_size?+o.local_size:void 0,s.alpha=void 0!==o.alpha?+o.alpha:void 0,s.beta=void 0!==o.beta?+o.beta:void 0,i=new t.LocalResponseNormalizationLayer(s);break;case"dropout":var a=e.dropout_param||{};s.drop_prob=void 0!==a.dropout_ratio?+a.dropout_ratio:void 0,i=new t.DropoutLayer(s);break;case"concat":var n=e.concat_param||{};s.axis=void 0!==n.axis?+n.axis:void 0,i=new t.ConcatLayer(s);break;case"pool":case"pooling":var h=e.pooling_param||{};s.pool=void 0!==h.pool?h.pool:void 0,s.sx=void 0!==h.kernel_size?+h.kernel_size:void 0,s.pad=void 0!==h.pad?+h.pad:void 0,s.stride=void 0!==h.stride?+h.stride:void 0,i=new t.PoolLayer(s);break;case"inner_product":case"innerproduct":var h=e.inner_product_param||{},o=e.param||{};s.num_neurons=void 0!==h.num_output?+h.num_output:void 0,s.l1_decay_mul=o&&o.length&&void 0!==o[0].decay_mult?+o[0].decay_mult:0,s.l2_decay_mul=o&&o.length&&void 0!==o[1].decay_mult?+o[1].decay_mult:1,i=new t.FullyConnectedLayer(s);break;case"softmax":i=new t.SoftmaxLayer(s);break;case"relu":i=new t.ReluLayer(s);break;case"sigmoid":i=new t.SigmoidLayer(s);break;case"tanh":i=new t.TanhLayer(s);break;default:return void console.error("Cannot parse layer "+e.type,e)}this.layers.set(i.name,i)},i.prototype.createLayers=function(e,i,r){var s=this;void 0===r&&(r=!1),this.layers=d3.map(),r&&this.layers.set("data",new t.InputLayer({name:"data",in_depth:+e.input_dim[1],in_sy:+e.input_dim[2],in_sx:+e.input_dim[3]})),i.forEach(function(t){return s.caffeLayerToJs(t)})},i.prototype.createEdges=function(){var t=this;this.edges=[],this.layers.values().filter(function(t){return void 0!==t.input&&t.input!==t.output}).forEach(function(e){Array.isArray(e.input)?e.input.forEach(function(i){t.edges.push({from:i,to:e.output})}):t.edges.push({from:e.input,to:e.output})}),this.layers.values().filter(function(t){return void 0!==t.input&&t.input===t.output}).forEach(function(e){t.edges.filter(function(t){return t.from===e.input}).forEach(function(i){i.from=e.name,t.edges.push({from:e.input,to:e.name})})})},i.prototype.loadWeights=function(){var t=this;return this.weightPath?Promise.all(this.layers.values().filter(function(t){return"conv"==t.layer_type||"fc"==t.layer_type}).map(function(e){return Promise.all([fetch(t.weightPath+e.name+"_filter.bin").then(function(t){return t.arrayBuffer()}).then(function(t){for(var i=new Float32Array(t),r=e.sx*e.sy*e.in_depth,s=0;s<e.out_depth;s++)e.filters[s].w.set(i.slice(s*r,s*r+r))}),fetch(t.weightPath+e.name+"_bias.bin").then(function(t){return t.arrayBuffer()}).then(function(t){var i=new Float32Array(t);e.biases.w.set(i)})])})):Promise.resolve()},i}(t.Net);t.CaffeModel=e}(Net||(Net={}));var ImgJS;!function(t){var e=NumJS,i=function(){function t(t){this.src=t,this.canvas=document.createElement("canvas"),this.image=document.createElement("img")}return t.prototype.set=function(t){return this.data=t.data,this.image.width=t.width,this.image.height=t.height,this},t.prototype.load=function(){var t=this;return new Promise(function(e,i){var r=t.canvas.getContext("2d");t.image.onload=function(){r.imageSmoothingEnabled=!1,t.canvas.width=t.image.width,t.canvas.height=t.image.height,r.drawImage(t.image,0,0);var i=r.getImageData(0,0,t.image.width,t.image.height);t.data=i.data,e(t.data)},t.image.src=t.src})},t.prototype.render=function(t){void 0===t&&(t=this.canvas,document.body.appendChild(t)),t.width=this.image.width,t.height=this.image.height;var e=t.getContext("2d");e.imageSmoothingEnabled=!1;var i=e.getImageData(0,0,this.image.width,this.image.height);i.data.set(this.data),e.putImageData(i,0,0)},t.fromFilter=function(e,i,r,s){return void 0===i&&(i=0),void 0===r&&(r=1),void 0===s&&(s=!0),t.fromVol(e,0,i,r,s)},t.fromVol=function(i,r,s,o,n,a){void 0===s&&(s=[2,1,0]),void 0===o&&(o=1),void 0===n&&(n=!1),void 0===a&&(a=255);var h=new t;r=void 0!==r?r:[0,0,0];for(var u=i.sx,p=i.sy,d=u*p*4,c=e.maxmin(i.w),f=s?s instanceof Array?s[0]:+s:0,_=s?s instanceof Array?s[1]:+s:0,l=s?s instanceof Array?s[2]:+s:0,y=new Uint8ClampedArray(d),v=0;v<p;v++)for(var m=0;m<u;m++){var g=4*(v*u+m),w=r?r[f]instanceof Array?+r[f][v*p+m]:+r[f]:0,x=r?r[_]instanceof Array?+r[_][v*p+m]:+r[_]:0,N=r?r[l]instanceof Array?+r[l][v*p+m]:+r[l]:0,S=i.get(m,v,f),b=i.get(m,v,_),J=i.get(m,v,l);n&&(S=Math.floor((i.get(m,v,f)-c.minv)/c.dv*255),b=Math.floor((i.get(m,v,_)-c.minv)/c.dv*255),J=Math.floor((i.get(m,v,l)-c.minv)/c.dv*255)),y[g+0]=S+w,y[g+1]=b+x,y[g+2]=J+N,y[g+3]=a}return h.image.width=u,h.image.height=p,h.data=y,h},t.prototype.toVol=function(t,e){void 0===e&&(e=[2,1,0]),t=void 0!==t?t:[0,0,0];for(var i=this.image.width,r=this.image.height,s=e[0],o=e[1],n=e[2],a=new Net.Vol(i,r,3,0),h=0;h<r;h++)for(var u=0;u<i;u++){var p=4*(h*i+u),d=t[s]instanceof Array?+t[s][h*r+u]:+t[s],c=t[o]instanceof Array?+t[o][h*r+u]:+t[o],f=t[n]instanceof Array?+t[n][h*r+u]:+t[n];a.set(u,h,s,this.data[p+0]-d),a.set(u,h,o,this.data[p+1]-c),a.set(u,h,n,this.data[p+2]-f)}return a},t}();t.Image=i}(ImgJS||(ImgJS={}));var Utils;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.render=function(t,e){void 0===e&&(e=600);var i=new dagreD3.render,r=this.createGraph(),s=d3.select(t);s.selectAll("*").remove();var o=s.append("svg").attr("width",e),n=o.append("g");i(n,r);var a=(e-r.graph().width)/2;n.attr("transform","translate("+a+", 20)"),o.attr("height",r.graph().height+40)},e.prototype.createGraph=function(){var t=this,e=(new dagreD3.graphlib.Graph).setGraph({}).setDefaultEdgeLabel(function(){return{}});return this.layerIterator(function(t,i,r){e.setNode(t.name,{labelType:"html",label:t.getDescription().join("<br>"),"class":"layer-"+t.layer_type})}),e.nodes().forEach(function(t){var i=e.node(t);i.rx=i.ry=5}),this.edges.filter(function(t){return void 0!==t.from&&void 0!==t.to}).forEach(function(i){e.setEdge(i.from,i.to,{label:t.layers.get(i.from).getOutputShape().join("x")})}),e},e.fromNet=function(t){var i=new e;return i.layers=t.layers,i.edges=t.edges,i},e}(Net.Net);t.GraphDrawer=e}(Utils||(Utils={}));var Utils;!function(t){var e=ImgJS,i=function(t){function i(){t.call(this)}return __extends(i,t),i.prototype.render=function(t){var i=d3.select(t);i.selectAll("*").remove(),this.layerIterator(function(t){i.append("h3").text("Layer type: "+t.name);var r=i.append("div").attr("class","net-layer"),s=r.append("div").attr("class","net-description"),o=r.append("div").attr("class","net-vis"),n=(o.append("div").attr("class","net-weights"),o.append("div").attr("class","net-activations"));s.append("span").text(t.layer_type);for(var a=0,h=t.out_act.depth;a<h;++a){var u=n.append("canvas");e.Image.fromFilter(t.out_act,a,1).render(u[0][0])}})},i.fromNet=function(t){var e=new i;return e.layers=t.layers,e.edges=t.edges,e},i}(Net.Net);t.FilterDrawer=i}(Utils||(Utils={}));